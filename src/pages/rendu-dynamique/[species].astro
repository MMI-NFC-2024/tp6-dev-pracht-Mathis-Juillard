---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import PlotFigure from "../../components/PlotFigure.astro";
import * as Plot from "@observablehq/plot";
import penguinsRaw from "../../assets/penguins.json";
import { COULEURS_ESPECES } from "../../lib/couleurs.ts";

const tidy = (rows) =>
  rows
    .filter(d => d.culmen_length_mm != null && d.culmen_depth_mm != null)
    .map(d => ({
      ...d,
      culmen_length_mm: +d.culmen_length_mm,
      culmen_depth_mm: +d.culmen_depth_mm
    }));

const makeOptions = (rows, title) => ({
  width: 920,
  height: 520,
  inset: 8,
  marks: [
    Plot.dot(rows, {
      x: "culmen_length_mm",
      y: "culmen_depth_mm",
      stroke: "species",
      fill: "species",
      r: 3.6,
      tip: true
    })
  ],
  x: { label: "Culmen length (mm)", grid: true },
  y: { label: "Culmen depth (mm)", grid: true },
  color: COULEURS_ESPECES,
  caption: title
});

const { species } = Astro.params;
const rows = tidy(penguinsRaw).filter(d => d.species === species);
const notFound = rows.length === 0;
const options = notFound ? null : makeOptions(rows, `${species} — Scatterplot`);
---

<Layout title={notFound ? "Espèce inconnue" : `TP6 — ${species}`}>
  <div class="mb-6">
    <div class="kicker">Dynamique</div>
    <h1 class="page-title">{notFound ? "Espèce inconnue" : species}</h1>
    <p class="text-slate-400">
      <a href="/rendu-dynamique" class="nav-pill">← retour</a>
    </p>
  </div>

  {notFound ? (
    <div class="card p-6">Aucune donnée pour <code class="text-pink-300">{species}</code>.</div>
  ) : (
    <div class="card p-5">
      <div class="overflow-x-auto rounded-xl border border-white/10 bg-slate-900/30 p-3">
        <PlotFigure options={options} />
      </div>
    </div>
  )}
</Layout>
